name: CleanUp Resources
on:
  push:
    branches:
      - main
  workflow_dispatch:
jobs:
  az_cleanup:
    if: ${{ vars.RUN_AZCLEANUP == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Setup Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az --version  # Verify installation
      - name: Login to Azure
        run: |
          az login --service-principal -u ${{ secrets.AUTO_AZURE_CLIENT_ID }} -p ${{ secrets.AUTO_AZURE_CLIENT_SECRET }} --tenant ${{ secrets.AUTO_AZURE_TENANT_ID }}
          az account set --subscription ${{ secrets.AUTO_AZURE_SUBSCRIPTION_ID }}
      - name: Install Bicep CLI
        run: az bicep install
      - name: Delete Bicep Deployment
        run: |
          az group delete \
              --name PSLCkmDraft \
              --yes \
              --no-wait